!function(a,b){"function"==typeof define&&define.amd?define([],function(){return a.OAuth=b(a)}):"undefined"!=typeof exports?module.exports=b(a):a.OAuth=b(a)}(this,function(){"use strict";var a={Error:{},Request:{}};return a.LoginContext=function(){this._credentials=null,this._loginCb=null,this._loginFnCb=null,this._loginFnOpts=null,this._loginOpts=null,this._requestManager=null},a.LoginContext.prototype={getCredentials:function(){return this._credentials},getLoginCb:function(){return this._loginCb},getLoginFnCb:function(){return this._loginFnCb},sendCredentials:function(a,b,c){this._credentials=a,this._loginFnCb=b,this._loginFnOpts=c,this._requestManager._login(this,a,b)},_setLoginCb:function(a){this._loginCb=a},_setLoginOpts:function(a){this._loginOpts=a},_setRequestManager:function(a){this._requestManager=a}},a.StorageManager=function(a){if(this._storage=localStorage,this._storageKey="oauth.js","undefined"==typeof Storage)throw new Error("Your browser does not support HTML5 Web Storage !");if("object"==typeof a){switch(a.storage){case"local":case null:case void 0:this._storage=localStorage;break;case"session":this._storage=sessionStorage;break;default:throw new Error("Invalid storage value provided !")}this._storageKey="string"==typeof a.storageKey?a.storageKey:"oauth.js"}},a.StorageManager.prototype={getAccessToken:function(){var a=this.getAccessTokenResponse(),b=null!==a?a.access_token:null;return null===b||void 0===b?null:b},getAccessTokenResponse:function(){var a=this._storage.getItem(this._storageKey+".accessTokenResponse");return null!==a?JSON.parse(a):null},getRefreshToken:function(){var a=this.getAccessTokenResponse(),b=null!==a?a.refresh_token:null;return null===b||void 0===b?null:b},persistRawAccessTokenResponse:function(a){this._storage.setItem(this._storageKey+".accessTokenResponse",a)}},a.UrlUtils={addArgument:function(a,b,c){var d=a,e=b+"=",f=a.indexOf(e);if(-1!==a.indexOf("?"))if(-1!==f){var g=d.substring(0,f+e.length),h=d.substring(g.length),i=h.indexOf("&");-1===i?d=g+c:(h=h.substring(i),d=g+c+h)}else d=d+"&"+e+c;else d=d+"?"+e+c;return d}},a.Request.AngularRequestManager=function(){},a.Request.AngularRequestManager.prototype={start:function(){}},a.Request.BackboneRequestManager=function(b){if(this._backupedBackboneDotAjax=null,this._loginContext=null,this._clientType="backbone",this._loginFn=null,this._parseErrorFn=null,this._clientId=null,this._storageManager=null,this._tokenEndpoint=null,"undefined"==typeof Backbone||null===Backbone)throw new Error("Backbone is not available !");if("function"!=typeof Backbone.ajax)throw new Error("No valid 'Backbone.ajax' method has been found !");if(this._backupedBackboneDotAjax=Backbone.ajax,"object"!=typeof b)throw new Error("A configuration object is required !");if("function"!=typeof b.loginFn)throw new Error("No login function is provided !");if(this._loginFn=b.loginFn,"undefined"==typeof b.clientId)throw new Error("No client id is provided !");if(this._clientId=b.clientId,"string"!=typeof b.tokenEndpoint)throw new Error("No token endpoint is provided or its valued is invalid !");if(this._tokenEndpoint=b.tokenEndpoint,"function"!=typeof b.parseErrorFn)throw new Error("No parse error function is provided !");this._parseErrorFn=b.parseErrorFn,this._storageManager=new a.StorageManager({storage:b.storage,storageKey:b.storageKey})},a.Request.BackboneRequestManager.prototype={getStorageManager:function(){return this._storageManager},getLoginStatus:function(a){a(null===this._storageManager.getAccessTokenResponse()?{status:"disconnected"}:{status:"connected",authResponse:this._storageManager.getAccessTokenResponse()})},_onTokenEndpointPostError:function(a){var b=this._loginContext.getLoginCb(),c=this._loginContext.getLoginFnCb();if("function"==typeof c){var d=$.Deferred();c({status:a.responseJSON.error,authResponse:a.responseJSON},function(){d.resolve()}),d.done(function(){b({status:a.responseJSON.error,authResponse:a.responseJSON})})}else b({status:a.responseJSON.error,authResponse:a.responseJSON})},_onTokenEndpointPostSuccess:function(a){var b=this._loginContext.getLoginCb(),c=this._loginContext.getLoginFnCb();if(this._storageManager.persistRawAccessTokenResponse(JSON.stringify(a)),"function"==typeof c){var d=$.Deferred();c({status:"connected",authResponse:a},function(){d.resolve()}),d.done(function(){b({status:"connected",authResponse:a})})}else b({status:"connected",authResponse:a})},_login:function(a){this._loginContext=a;var b=null,c=this._loginContext.getCredentials();if("password"===c.grant_type)b=$.ajax({contentType:"application/x-www-form-urlencoded; charset=UTF-8",data:{grant_type:c.grant_type,client_id:this._clientId,username:c.username,password:c.password},type:"POST",url:this._tokenEndpoint});else{if("gomoob_facebook_access_token"!==c.grant_type)throw new Error("Unknown 'grant_type' = '"+c.grant_type+"' !");b=$.ajax({contentType:"application/x-www-form-urlencoded; charset=UTF-8",data:{grant_type:c.grant_type,client_id:this._clientId,facebook_access_token:c.facebook_access_token,facebook_app_scoped_user_id:c.facebook_app_scoped_user_id},type:"POST",url:this._tokenEndpoint})}b.done($.proxy(this._onTokenEndpointPostSuccess,this)),b.fail($.proxy(this._onTokenEndpointPostError,this))},login:function(b,c){null===this._storageManager.getAccessTokenResponse()?(this._loginContext=new a.LoginContext,this._loginContext._setLoginCb(b),this._loginContext._setLoginOpts(c),this._loginContext._setRequestManager(this),this._loginFn(this._loginContext)):b({status:"connected",authResponse:this._storageManager.getAccessTokenResponse()})},logout:function(){},start:function(){var a=this;Backbone.ajax=function(){return a._overwrittenBackboneDotAjax.apply(a,arguments)}},_cloneAjaxArguments:function(a){var b={};return"string"==typeof a[0]?(b[0]=a[0],2===b.length&&(b[1]=this._cloneAjaxSettings(a[1]))):b[0]=this._cloneAjaxSettings(a[0]),b},_cloneAjaxSettings:function(a){for(var b=["accepts","async","beforeSend","cache","complete","contents","contentType","context","converters","crossDomain","data","dataFilter","dataType","error","global","headers","isModified","isLocal","jsonp","jsonpCallback","mimeType","password","processData","scriptCharset","statusCode","success","timeout","traditional","type","url","username","xhr","xhrFields"],c={},d=0;d<b.length;++d)"undefined"!=typeof a[b[d]]&&(c[b[d]]=a[b[d]]);return c},_createOAuthPromise:function(a){var b=$.Deferred();return b.getResponseHeader=function(b){return a.getResponseHeader(b)},b.getAllResponseHeaders=function(){return a.getAllResponseHeaders()},b.setRequestHeader=function(b,c){return a.setRequestHeader(b,c),this},b.overrideMimeType=function(b){return a.overrideMimeType(b),this},b.statusCode=function(b){return a.statusCode(b),this},b.abort=function(b){return a.abort(b),this},b.success=b.done,b.error=b.fail,b.readyState=a.readyState,b.status=a.status,b.statusText=a.statusText,b},_jQueryAjaxPromiseDone:function(a,b,c,d,e){b.resolve(c,d,e)},_jQueryAjaxPromiseFail:function(a,b,c,d,e){var f=this._parseErrorFn(c);if(void 0!==f)switch(f){case"refresh":this._refreshAccessToken(a,b);break;case"reniew":this._reniewAccessToken(a,b);break;default:throw new Error("Action '"+f+"' is invalid !")}else b.reject(c,d,e)},_updateAjaxArgumentsWithAccessToken:function(b){var c=this._storageManager.getAccessToken();c&&("string"==typeof b[0]?b[0]=a.UrlUtils.addArgument(b[0],"access_token",c):b[0].secured&&(b[0].data||(b[0].data={}),b[0].data.access_token=c))},_overwrittenBackboneDotAjax:function(){var a=this._cloneAjaxArguments(arguments);this._updateAjaxArgumentsWithAccessToken(arguments);var b=Backbone.$.ajax.apply(Backbone.$,arguments),c=this._createOAuthPromise(b);return b.fail($.proxy(this._jQueryAjaxPromiseFail,this,a,c)),b.done($.proxy(this._jQueryAjaxPromiseDone,this,a,c)),c},_onOriginalRequestReplayedDone:function(a,b,c,d){a.resolve(b,c,d)},_onOriginalRequestReplayedFail:function(a,b,c,d){a.reject(b,c,d)},_onRefreshAccessTokenSuccess:function(a,b,c){this._storageManager.persistRawAccessTokenResponse(JSON.stringify(c));var d=this._cloneAjaxArguments(a);d[0].secured=!0,this._updateAjaxArgumentsWithAccessToken(d);var e=$.ajax(d[0]);e.done($.proxy(this._onOriginalRequestReplayedDone,this,b)),e.fail($.proxy(this._onOriginalRequestReplayedFail,this,b))},_onReniewAccessTokenSuccess:function(a,b,c){this._storageManager.persistRawAccessTokenResponse(JSON.stringify(c));var d=$.ajax(a);d.done($.proxy(this._onOriginalRequestReplayedDone,this,b)),d.fail($.proxy(this._onOriginalRequestReplayedFail,this,b))},_refreshAccessToken:function(a,b){var c=this._storageManager.getRefreshToken();if(c){var d=$.ajax({url:this._tokenEndpoint,data:{grant_type:"refresh_token",refresh_token:c,client_id:this._clientId},dataType:"json",type:"POST"});d.fail($.proxy(this._reniewAccessToken,this,b)),d.done($.proxy(this._onRefreshAccessTokenSuccess,this,a,b))}else this._reniewAccessToken(a,b)},_reniewAccessToken:function(a,b){if(null===this._loginContext)throw new Error("No login context found, did you miss to wrap your calls in 'OAuth.login' ?");console.log("_reniewAccessToken");var c=$.Deferred();this._loginContext._setRequestManager(this),this._loginFn(this._loginContext),c.done($.proxy(this._onCredentialsPromiseDone,this,a,b)),c.fail($.proxy(function(){console.log("_reniewAccessToken Error !")},this))},_onCredentialsPromiseDone:function(a,b,c){switch(c.grant_type){case"password":var d=$.ajax({contentType:"application/x-www-form-urlencoded; charset=UTF-8",data:{grant_type:"password",username:c.username,password:c.password,client_id:this._clientId},type:"POST",url:this._tokenEndpoint});d.done($.proxy(this._onReniewAccessTokenSuccess,this,a,b));break;case"client_credentials":$.ajax({contentType:"application/x-www-form-urlencoded; charset=UTF-8",data:{grant_type:"client_credentials",client_id:this._clientId},type:"POST",url:this._tokenEndpoint})}}},a.init=function(b,c){switch(b){case"angular":a._requestManager=new a.Request.AngularRequestManager(c);break;case"backbone":a._requestManager=new a.Request.BackboneRequestManager(c);break;default:throw new Error("Unknown or unsupported framework '"+b+"' !")}a._requestManager.start()},a.login=function(b,c){a._requestManager.login(b,c)},a});
//# sourceMappingURL=oauth.min.js.map